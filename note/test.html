<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>双向数据绑定</title>
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
<div class="content">
    <div class="t">双向数据绑定</div>
    <p class="date clear">2018-01-22</p>
    <div class="clear"></div>
    <h1>数据劫持</h1>
    <h2>监听器-Observer</h2>
    <p>数据监听器Observer，能够对数据对象的所有属性进行监听，如有变动可拿到最新值并通知订阅者</p>
    <pre class="lang-js">
    function Observer(obj, key, value) {
        var dep = new Dep();
        if(Object.prototype.toString.call(value) === '[Object Object]') {
            Object.keys(value).foreEach(function(key) {
                new Observer(value, key, value[key]);
            });
        }
        Object.defineProperty(obj, key, {
            enumerable: true,
            configuration: true,
            get: function () {
                if(Dep.target) {
                    dep.addSub(Dep.target);
                }
                return value;
            },
            set: function (newValue) {
                value = newValue;
                dep.notify();
            }
        })
    }
    </pre>
    <h2>消息订阅器-Dep</h2>
    <p>用于收集订阅者</p>
    <pre class="lang-js">
    function Dep() {
        this.subs = [];
        this.addSub = function (watcher) {
            this.subs.push(watcher);
        };
        this.notify = function () {
            this.subs.forEach(function (watcher) {
                watcher.update();
            });
        };
    }
    </pre>
    <h2>订阅者-Watcher</h2>
    <p>1、在自身实例化时往属性订阅器(dep)里面添加自己</p>
    <p>2、自身必须有一个update()方法</p>
    <p>3、待属性变动dep.notice()通知时，能调用自身的update()方法</p>
    <pre class="lang-js">
    function Watcher(fn) {
        this.update = function () {
            Dep.target = this;
            fn ();
            Dep.target = null;
        };
        this.update();
    }
    </pre>
    <h2>使用</h2>
    <pre class="lang-html">
    &lt;div id=&quot;book&quot;&gt;&lt;/div&gt;
    </pre>
    <pre class="lang-js">
    var book = {
        no: 1,
        name: 'book_name'
    };
    Object.keys(book).forEach(function (key) {
        new Observer(book, key, book[key]);
    });
    new Watcher(function () {
        document.querySelector('#test').innerHTML = book.name;
    });
    </pre>
</div>
</body>
</html>