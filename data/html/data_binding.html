<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="update_time" content="1518445369">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>双向数据绑定</title>
    <link rel="stylesheet" href="../../css/reset.css?v1518445369">
    <link rel="stylesheet" href="../../css/md.css?v1518445369">
    <link rel="stylesheet" href="../../css/module.css?v1518445369">
    <link rel="stylesheet" href="../../dep/highlight/style/monokai_sublime.css?v1518445369">
    <script src="../../dep/require.js?1518445369"></script>
</head>
<body>
<div class="md"><h1>双向数据绑定</h1>
<h6>2018.01.22</h6>
<h2>数据劫持</h2>
<h3>监听器-Observer</h3>
<p>数据监听器Observer，能够对数据对象的所有属性进行监听，如有变动可拿到最新值并通知订阅者</p>
<pre><code class="language-js" data-comment="">function Observer(obj, key, value) {
    var dep = new Dep();
    if(Object.prototype.toString.call(value) === '[Object Object]') {
        Object.keys(value).foreEach(function(key) {
            new Observer(value, key, value[key]);
        });
    }
    Object.defineProperty(obj, key, {
        enumerable: true,
        configuration: true,
        get: function () {
            if(Dep.target) {
                dep.addSub(Dep.target);
            }
            return value;
        },
        set: function (newValue) {
            value = newValue;
            dep.notify();
        }
    })
}</code></pre>
<h3>消息订阅器-Dep</h3>
<p>用于收集订阅者</p>
<pre><code class="language-js" data-comment="">function Dep() {
    this.subs = [];
    this.addSub = function (watcher) {
        this.subs.push(watcher);
    };
    this.notify = function () {
        this.subs.forEach(function (watcher) {
            watcher.update();
        });
    };
}</code></pre>
<h3>订阅者-Watcher</h3>
<p>1、在自身实例化时往属性订阅器(dep)里面添加自己</p>
<p>2、自身必须有一个update()方法</p>
<p>3、待属性变动dep.notice()通知时，能调用自身的update()方法</p>
<pre><code class="language-js" data-comment="">function Watcher(fn) {
    this.update = function () {
        Dep.target = this;
        fn ();
        Dep.target = null;
    };
    this.update();
}</code></pre>
<h3>使用</h3>
<pre><code class="language-html" data-comment="">&lt;div id="test"&gt;&lt;/div&gt;</code></pre>
<pre><code class="language-js" data-comment="">var book = {
    no: 1,
    name: 'book_name'
};
Object.keys(book).forEach(function (key) {
    new Observer(book, key, book[key]);
});
new Watcher(function () {
    document.querySelector('#test').innerHTML = book.name;
});</code></pre>
<h3>参考</h3>
<p><a href="https://segmentfault.com/a/1190000006599500">剖析Vue原理&amp;实现双向绑定MVVM</a></p>
<h6>2018.01.23</h6></div>
<script >
    requirejs(['../../js/conf/r'], function(rc) {
        requirejs(['../js/html']);
    });
</script>
</body>
</html>