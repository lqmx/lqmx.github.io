<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="update_time" content="1519999710">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>MySQL技术内幕 第三章 文件</title>
    <link rel="shortcut icon" type="images/x-icon" href="/favicon.png?v1519999710">
    <link rel="stylesheet" href="../../css/reset.css?v1519999710">
    <link rel="stylesheet" href="../../css/md.css?v1519999710">
    <link rel="stylesheet" href="../../css/module.css?v1519999710">
    <link rel="stylesheet" href="../../css/c.css?v1519999710">
    <link rel="stylesheet" href="../../dep/highlight/style/monokai_sublime.css?v1519999710">
    <script src="../../dep/require.js?1519999710"></script>
</head>
<body>
    <div class="md"><h1>第三章 文件</h1>
<h6>2018.03.02</h6>
<ul>
<li>参数文件：记录数据库文件位置，指定某些初始化参数</li>
<li>日志文件： 记录MySQL实例对某种条件作出响应时写入的文件，如错误日志文件、二进制日志文件、慢查询日志文件、查询日志文件等。</li>
<li>socket文件：当用UNIX域套接字方式连接时需要的文件</li>
<li>pid文件：MySQL实例的进程ID文件</li>
<li>MySQL表结构文件：存放MySQL表结构定义文件</li>
<li>存储引擎文件：存储了记录和索引等数据</li>
</ul>
<h2>3.1 参数文件</h2>
<pre><code class="language-bash" data-comment=""># 参数文件位置
mysql --help | grep my.cnf</code></pre>
<h3>3.1.1 什么是参数</h3>
<p>简单地说，可以把数据库参数看成一个键/值对</p>
<h3>3.1.2 参数类型</h3>
<ul>
<li>动态参数 可以在MySQL实例运行中进行更改</li>
<li>静态参数 在整个实例生命周期内不得进行更改</li>
</ul>
<pre><code class="language-mysql" data-comment="">set read_buffer_size=524288;
select @@session.read_buffer_size;
select @@global.read_buffer_size;
set @@global.read_buffer_size=104857;
select @@`session.read_buffer_size`;
select @@`global.read_buffer_size`;</code></pre>
<h2>3.2 日志文件</h2>
<p>日志文件记录了影响MySQL数据库的各种类型活动。</p>
<p>常见日志文件：</p>
<ul>
<li>错误日志 error log</li>
<li>二进制日志 binlog</li>
<li>慢查询日志 slow query log</li>
<li>查询日志 log</li>
</ul>
<h3>3.2.1 错误日志</h3>
<p>错误日志对MySQL的启动、运行、关闭过程进行了记录。</p>
<pre><code class="language-mysql" data-comment="">-- 定位错误日志文件
show variables like 'log_error';</code></pre>
<h3>3.2.2 慢查询日志</h3>
<p>慢查询日志可定位可能存在问题的SQL语句。</p>
<pre><code class="language-mysql" data-comment="">-- 慢查询日志阈值
show variables like 'long_query_time';
-- 慢查询是否开启
show variables like 'log_slow_queries';
-- 是否使用索引参数
show variables like 'log_queries_not_using_indexes';
-- 每分钟记录到slow log的且未使用索引的SQL数
show variables like 'log_queries_not_using_indexes';</code></pre>
<pre><code class="language-bash" data-comment=""># 慢查询日志文件分析
mysqldumpslow nh122-190-slow.log
# 时间最长前十
mysqldumpslow -s al -n 10 david.log</code></pre>
<pre><code class="language-mysql" data-comment="">show create table mysql.slow_log;
show variables like 'log_output';
set global log_output='table';
show variables like 'log_output';
select sleep(10);
select * from mysql.slow_log;
alter table mysql.slow_log engine=myisam;
set global slow_query_log=off;
alter table mysql.slow_log engine=myisam;</code></pre>
<p><code class="inline-code">long_query_io</code>：超过指定逻辑IO次数的SQL语句记录到slow log中</p>
<p><code class="inline-code">slow_query_type</code>：启动slow log的方式</p>
<ul>
<li>0表示不将SQL语句记录到slow log</li>
<li>1表示根据运行时间将SQL语句记录到slow log</li>
<li>2表示根据逻辑IO次数将SQL记录到slow log</li>
<li>3表示根据运行时间及逻辑IO次数将SQL语句记录到slow log</li>
</ul>
<h3>3.2.3 查询日志</h3>
<p>查询日志记录了所有对MySQL数据库请求的信息，无论这些请求是否得到了正确的执行。</p>
<p>可以将查询日志记录到<code class="inline-code">general_log</code>表中</p>
<h3>3.2.4 二进制日志</h3>
<p>二进制日志记录了对MySQL数据库执行更改的所有操作，不包括SELECT和SHOW这类操作。
若操作本身并没有导致数据库发生变化，该操作也会被记录。</p>
<p>二进制日志主要作用：</p>
<ul>
<li>数据恢复</li>
<li>数据复制</li>
<li>审计：用户可以通过二进制日志中的信息进行审计，判断是否有对数据库进行注入的攻击</li>
</ul>
<pre><code class="language-ini" data-comment="">lgo-bin [=name]</code></pre>
<p>以下参数影响二进制日志记录的信息和行为：</p>
<ul>
<li>max_binlog_size 单个二进制日志文件的最大值</li>
<li>binlog_cache_size 二进制事务提交缓冲大小，基于会话</li>
<li>sync_binlog 每写缓冲多少次就同步到磁盘</li>
<li>binlog-do-db 需要写入哪些库的日志</li>
<li>binlog-ignore-db 需要忽略写入哪些库的日志</li>
<li>log-slave-update slave是否取得并执行二进制日志写入自己的二进制日志文件中</li>
<li>binlog_format 日志格式</li>
</ul>
<pre><code class="language-mysql" data-comment="">show variables like 'binlog_cache_size';
show global status like 'binlog_cache%';</code></pre>
<p>binlog_format的值：</p>
<ul>
<li>STATEMENT 二进制日志文件记录的是日志的逻辑SQL语句</li>
<li>ROW 记录表的行更改情况</li>
<li>MIXED 默认采用STATEMNET，以下情况用ROW
<ul>
<li>表的存储引擎为NDB，表的所有DML操作会以ROW记录</li>
<li>使用了UUID(),USER(),CURRENT_USER(),FOUND_ROWS(),ROW_COUNT()等不确定函数</li>
<li>使用了INSERT DELAY语句</li>
<li>使用了用户定义函数（UDF）</li>
<li>使用了临时表</li>
</ul></li>
</ul>
<p>binlog_format对于存储引擎的限制</p>
<table>
<thead>
<tr>
<th>存储引擎</th>
<th>ROW格式</th>
<th>Statement格式</th>
</tr>
</thead>
<tbody>
<tr>
<td>InnoDB</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>MyISAM</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>HEAP</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>MERGE</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>NDB</td>
<td>yes</td>
<td>no</td>
</tr>
<tr>
<td>Archive</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>CSV</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>Federate</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>Blockhole</td>
<td>no</td>
<td>yes</td>
</tr>
</tbody>
</table>
<pre><code class="language-mysql" data-comment="">set @@session.binlog_format='row';
select @@`session.binlog_format`;</code></pre>
<p>将binlog_format设置为ROW，可以为数据库的回复和复制带来更好的可靠性，但是会带来二进制文件大小的增加。</p>
<pre><code class="language-bash" data-comment=""># 查看binlog的内容
mysqlbinlog --start-position=203 test.000004</code></pre>
<h2>3.3 套接字文件</h2>
<pre><code class="language-mysql" data-comment="">show variables like 'socket';</code></pre>
<h2>3.4 pid文件</h2>
<pre><code class="language-mysql" data-comment="">show variables like 'pid_file';</code></pre>
<h2>3.5 表结构定义文件</h2>
<p><code class="inline-code">.frm</code>：记录表的表、视图结构定义</p>
<h2>3.5 InnoDB存储引擎文件</h2>
<h3>3.6.1 表空间文件</h3>
<p>InnoDB采用将存储的数据按表空间进行存放的设计。</p>
<pre><code class="language-ini" data-comment="">innodb_data_path=/db/ibdata1:2000M;/dr2/db/ibdata2:2000M:autoextend</code></pre>
<pre><code class="language-mysql" data-comment="">show variables like 'innodb_file_per_table';</code></pre>
<h3>3.6.2 重做日志文件</h3>
<p>在InnoDB存储的数据目录下有两个名为ib_logfile0和ib_logfile1的重做日志文件，记录了对于InnoDB存储引擎的事务日志。</p>
<p>影响重做日志文件属性的参数</p>
<ul>
<li>innodb_log_file_size 每个重做日志文件的大小</li>
<li>innodb_log_files_in_group 日志文件组中重做日志的数量</li>
<li>innodb_mirrored_log_groups 日志镜像文件组的数量</li>
<li>innodb_log_group_home_dir 日志文件组所在目录</li>
</ul>
<pre><code class="language-mysql" data-comment="">show variables like 'innodb%log';</code></pre>
<p>重做日志文件设置太大，恢复需要很长时间。重做日志文件设置太小，导致一个事务的日志多次切换重做日志文件，而且会导致频繁地
发生async checkpoint，导致性能到抖动。</p>
<p>与二进制日志的区别</p>
<ol>
<li>二进制日志会记录所有与MySQL数据库有关的日志记录，重做日志只记录有关改存储引擎的事务日志。</li>
<li>记录的内容不同，二进制日志记录的都是关于一个事务的具体操作的内容，即该日志是逻辑日志。二重做日志记录的是关于每个页的更改的
物理情况</li>
<li>二进制日志仅在事务提交前进行提交，即只写磁盘一次。重做日志会不断在事务进行过程中写入。</li>
</ol>
<p>重做日志条目结构</p>
<ul>
<li>redo_log_type 1字节，表示重做日志的类型</li>
<li>space 表示空间的ID</li>
<li>page_no 表示页的偏移量</li>
<li>redo_log_body 每个重做日志的数据部分</li>
</ul>
<p>从日志缓冲写入磁盘上的重做日志的条件</p>
<ol>
<li>主线程每秒会将重做日志缓冲写入磁盘，不论事务是否已提交</li>
<li>由参数innodb_flush_log_at_trx_commit控制，表示在提交时，处理重做日志的方式</li>
</ol>
<p>innodb_flush_log_at_trx_commit的值</p>
<ul>
<li>0 提交事务时，并不将事务的重做日志写入磁盘的日志文件，而是等待主线程每秒的刷新</li>
<li>1 在执行commit时将重做日志同步写到磁盘</li>
<li>2 将重做日志异步写到磁盘，即写到文件系统缓存中</li>
</ul>
<p>为了保证事务的ACID中的持久性，必须将innodb_flush_log_at_trx_commit的值设置为1</p>
<h2>3.7 小结</h2>
<h6>2018.03.02</h6></div>
<script >
    requirejs(['../../js/conf/r'], function(rc) {
        requirejs(['../js/html']);
    });
</script>
</body>
</html>