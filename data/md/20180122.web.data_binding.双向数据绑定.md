# 双向数据绑定

###### 2018.01.22

## 数据劫持

### 监听器-Observer

数据监听器Observer，能够对数据对象的所有属性进行监听，如有变动可拿到最新值并通知订阅者

```js
function Observer(obj, key, value) {
    var dep = new Dep();
    if(Object.prototype.toString.call(value) === '[Object Object]') {
        Object.keys(value).foreEach(function(key) {
            new Observer(value, key, value[key]);
        });
    }
    Object.defineProperty(obj, key, {
        enumerable: true,
        configuration: true,
        get: function () {
            if(Dep.target) {
                dep.addSub(Dep.target);
            }
            return value;
        },
        set: function (newValue) {
            value = newValue;
            dep.notify();
        }
    })
}
```

### 消息订阅器-Dep

用于收集订阅者

```js
function Dep() {
    this.subs = [];
    this.addSub = function (watcher) {
        this.subs.push(watcher);
    };
    this.notify = function () {
        this.subs.forEach(function (watcher) {
            watcher.update();
        });
    };
}
```

### 订阅者-Watcher

1、在自身实例化时往属性订阅器(dep)里面添加自己

2、自身必须有一个update()方法

3、待属性变动dep.notice()通知时，能调用自身的update()方法

```js
function Watcher(fn) {
    this.update = function () {
        Dep.target = this;
        fn ();
        Dep.target = null;
    };
    this.update();
}
```

### 使用

```html
<div id="test"></div>
```

```js
var book = {
    no: 1,
    name: 'book_name'
};
Object.keys(book).forEach(function (key) {
    new Observer(book, key, book[key]);
});
new Watcher(function () {
    document.querySelector('#test').innerHTML = book.name;
});
```

### 参考
[剖析Vue原理&实现双向绑定MVVM](https://segmentfault.com/a/1190000006599500)

###### 2018.01.23